generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============================================
// TYPE CONSTANTS (SQLite doesn't support enums)
// ============================================
// LocationType: "ZONE" | "RACK" | "SHELF" | "BIN"
// MovementType: "IN" | "OUT" | "TRANSFER"
// OrderStatus: "DRAFT" | "PENDING" | "CONFIRMED" | "SHIPPED" | "DELIVERED" | "CANCELLED"
// POStatus: "DRAFT" | "SENT" | "CONFIRMED" | "PARTIAL" | "RECEIVED" | "CANCELLED"
// InvoiceStatus: "DRAFT" | "SENT" | "PAID" | "PARTIAL" | "OVERDUE" | "CANCELLED" | "REFUNDED"
// InvoiceType: "SALES" | "PURCHASE" | "CREDIT_NOTE" | "DEBIT_NOTE"
// PaymentMethod: "CASH" | "BANK_TRANSFER" | "CREDIT_CARD" | "CHECK" | "OTHER"
// QualityStatus: "PENDING" | "APPROVED" | "REJECTED" | "QUARANTINE"
// SerialStatus: "IN_STOCK" | "SOLD" | "RETURNED" | "DEFECTIVE" | "RESERVED"
// LeadStatus: "NEW" | "CONTACTED" | "QUALIFIED" | "UNQUALIFIED" | "CONVERTED"
// LeadSource: "WEBSITE" | "REFERRAL" | "COLD_CALL" | "TRADE_SHOW" | "SOCIAL_MEDIA" | "OTHER"
// LeadRating: "HOT" | "WARM" | "COLD"
// OpportunityStage: "PROSPECTING" | "QUALIFICATION" | "PROPOSAL" | "NEGOTIATION" | "CLOSED_WON" | "CLOSED_LOST"
// ActivityType: "CALL" | "EMAIL" | "MEETING" | "TASK" | "NOTE"

// ============================================
// CORE MODELS
// ============================================

model Product {
  id          String   @id @default(cuid())
  name        String
  sku         String   @unique
  category    String
  
  // The Basics
  currentStock Int      @default(0)
  price        Decimal
  cost         Decimal // Cost to acquire
  
  // The "Balance" Fields
  reorderPoint Int      @default(10) // Safety Stock / Min Level
  maxStock     Int      @default(100) // Liquidity Cap / Max Level
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  stockItems       StockItem[]
  stockMovements   StockMovement[]
  purchaseItems    PurchaseOrderItem[]
  salesItems       SalesOrderItem[]
  supplierProducts SupplierProduct[]
  invoiceItems     InvoiceItem[]
  batches          Batch[]
  serialNumbers    SerialNumber[]

  @@map("products")
}

// ============================================
// WAREHOUSE MANAGEMENT
// ============================================

model Warehouse {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique // Short code like "WH-001"
  address     String?
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  locations   Location[]

  @@map("warehouses")
}

model Location {
  id          String       @id @default(cuid())
  name        String       // e.g., "Zone A", "Rack 1", "Shelf 3", "Bin A1"
  code        String       // e.g., "WH001-A-R1-S3-B1"
  type        String       // "ZONE" | "RACK" | "SHELF" | "BIN"
  capacity    Int?         // Optional max capacity
  
  // Self-referential tree structure
  parentId    String?
  parent      Location?    @relation("LocationTree", fields: [parentId], references: [id])
  children    Location[]   @relation("LocationTree")
  
  // Warehouse relation
  warehouseId String
  warehouse   Warehouse    @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  stockItems          StockItem[]
  outgoingMovements   StockMovement[] @relation("FromLocation")
  incomingMovements   StockMovement[] @relation("ToLocation")
  batches             Batch[]
  serialNumbers       SerialNumber[]
  batchOutgoing       BatchMovement[] @relation("BatchFromLocation")
  batchIncoming       BatchMovement[] @relation("BatchToLocation")

  @@unique([warehouseId, code])
  @@map("locations")
}

// ============================================
// STOCK TRACKING
// ============================================

model StockItem {
  id          String   @id @default(cuid())
  quantity    Int      @default(0)
  
  // Product relation
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Location relation
  locationId  String
  location    Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Composite unique: one stock record per product per location
  @@unique([productId, locationId])
  @@map("stock_items")
}

model StockMovement {
  id          String       @id @default(cuid())
  type        String       // "IN" | "OUT" | "TRANSFER"
  quantity    Int
  reference   String?      // PO number, SO number, transfer ref, etc.
  notes       String?
  
  // Product relation
  productId   String
  product     Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // For IN movements: toLocation only
  // For OUT movements: fromLocation only
  // For TRANSFER: both fromLocation and toLocation
  fromLocationId String?
  fromLocation   Location?  @relation("FromLocation", fields: [fromLocationId], references: [id])
  
  toLocationId   String?
  toLocation     Location?  @relation("ToLocation", fields: [toLocationId], references: [id])
  
  // Audit fields
  createdAt   DateTime     @default(now())
  createdBy   String?      // User ID reference
  user        User?        @relation(fields: [createdBy], references: [id])

  @@map("stock_movements")
}

// ============================================
// USER MANAGEMENT
// ============================================
// UserRole: "ADMIN" | "MANAGER" | "OPERATOR" | "VIEWER"

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String?  // Hashed password for credentials auth
  name        String
  avatar      String?  // URL to avatar image
  role        String   @default("OPERATOR") // "ADMIN" | "MANAGER" | "OPERATOR" | "VIEWER"
  isActive    Boolean  @default(true)
  emailVerified DateTime? // For email verification
  
  // Preferences (stored as JSON string for SQLite)
  preferences String?  // JSON: { theme, notifications, language, timezone }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime?

  // Relations
  stockMovements    StockMovement[]
  purchaseOrders    PurchaseOrder[]
  salesOrders       SalesOrder[]
  invoices          Invoice[]
  payments          Payment[]
  batchMovements    BatchMovement[]
  leadsAssigned     Lead[] @relation("LeadAssignment")
  opportunitiesAssigned Opportunity[] @relation("OpportunityAssignment")
  activitiesAssigned Activity[] @relation("ActivityAssignment")
  activitiesCreated  Activity[] @relation("ActivityCreator")
  
  // NextAuth relations
  accounts          Account[]
  sessions          Session[]

  @@map("users")
}

// ============================================
// SUPPLIER MANAGEMENT
// ============================================

model Supplier {
  id           String   @id @default(cuid())
  name         String
  code         String   @unique // e.g., "SUP-001"
  email        String?
  phone        String?
  address      String?
  contactName  String?
  website      String?
  notes        String?
  isActive     Boolean  @default(true)
  
  // Payment terms
  paymentTerms String?  // e.g., "Net 30", "Net 60"
  leadTimeDays Int?     // Average lead time in days
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  products       SupplierProduct[]
  purchaseOrders PurchaseOrder[]
  invoices       Invoice[]
  batches        Batch[]

  @@map("suppliers")
}

model SupplierProduct {
  id            String   @id @default(cuid())
  supplierSku   String?  // Supplier's SKU for this product
  unitCost      Decimal  // Cost from this supplier
  minOrderQty   Int      @default(1)
  leadTimeDays  Int?     // Lead time for this specific product
  isPreferred   Boolean  @default(false) // Preferred supplier for this product
  
  // Relations
  supplierId    String
  supplier      Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([supplierId, productId])
  @@map("supplier_products")
}

// ============================================
// PURCHASE ORDERS
// ============================================
// POStatus: "DRAFT" | "SENT" | "CONFIRMED" | "PARTIAL" | "RECEIVED" | "CANCELLED"

model PurchaseOrder {
  id              String   @id @default(cuid())
  orderNumber     String   @unique // e.g., "PO-2024-001"
  status          String   @default("DRAFT")
  
  // Dates
  orderDate       DateTime @default(now())
  expectedDate    DateTime? // Expected delivery date
  receivedDate    DateTime? // Actual received date
  
  // Financial
  subtotal        Decimal  @default(0)
  tax             Decimal  @default(0)
  shipping        Decimal  @default(0)
  total           Decimal  @default(0)
  
  notes           String?
  
  // Relations
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  
  createdById     String?
  createdBy       User?    @relation(fields: [createdById], references: [id])
  
  // Delivery location
  warehouseId     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Line items
  items           PurchaseOrderItem[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String   @id @default(cuid())
  quantity        Int
  unitCost        Decimal
  receivedQty     Int      @default(0) // Quantity actually received
  
  // Relations
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("purchase_order_items")
}

// ============================================
// CUSTOMERS & SALES ORDERS
// ============================================

model Customer {
  id           String   @id @default(cuid())
  name         String
  code         String   @unique // e.g., "CUST-001"
  email        String?
  phone        String?
  address      String?
  contactName  String?
  company      String?
  notes        String?
  isActive     Boolean  @default(true)
  
  // Credit terms
  creditLimit  Decimal? 
  paymentTerms String?  // e.g., "Net 30"
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  salesOrders       SalesOrder[]
  invoices          Invoice[]
  serialNumbers     SerialNumber[]
  opportunities     Opportunity[]
  activities        Activity[]
  convertedFromLead Lead? @relation("LeadConversion")

  @@map("customers")
}

// OrderStatus: "DRAFT" | "PENDING" | "CONFIRMED" | "SHIPPED" | "DELIVERED" | "CANCELLED"

model SalesOrder {
  id              String   @id @default(cuid())
  orderNumber     String   @unique // e.g., "SO-2024-001"
  status          String   @default("DRAFT")
  
  // Dates
  orderDate       DateTime @default(now())
  shippedDate     DateTime?
  deliveredDate   DateTime?
  
  // Financial
  subtotal        Decimal  @default(0)
  tax             Decimal  @default(0)
  shipping        Decimal  @default(0)
  discount        Decimal  @default(0)
  total           Decimal  @default(0)
  
  // Shipping info
  shippingAddress String?
  trackingNumber  String?
  
  notes           String?
  
  // Relations
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  
  createdById     String?
  createdBy       User?    @relation(fields: [createdById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Line items
  items           SalesOrderItem[]

  @@map("sales_orders")
}

model SalesOrderItem {
  id              String   @id @default(cuid())
  quantity        Int
  unitPrice       Decimal
  shippedQty      Int      @default(0) // Quantity actually shipped
  
  // Relations
  salesOrderId    String
  salesOrder      SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("sales_order_items")
}

// ============================================
// INVOICING & PAYMENTS
// ============================================
// InvoiceStatus: "DRAFT" | "SENT" | "PAID" | "PARTIAL" | "OVERDUE" | "CANCELLED" | "REFUNDED"
// InvoiceType: "SALES" | "PURCHASE" | "CREDIT_NOTE" | "DEBIT_NOTE"
// PaymentMethod: "CASH" | "BANK_TRANSFER" | "CREDIT_CARD" | "CHECK" | "OTHER"

model Invoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique // e.g., "INV-2024-001"
  type            String   @default("SALES") // "SALES" | "PURCHASE" | "CREDIT_NOTE" | "DEBIT_NOTE"
  status          String   @default("DRAFT")
  
  // Dates
  invoiceDate     DateTime @default(now())
  dueDate         DateTime
  paidDate        DateTime?
  
  // Financial
  subtotal        Decimal  @default(0)
  taxRate         Decimal  @default(0) // Tax percentage (e.g., 18 for 18%)
  taxAmount       Decimal  @default(0)
  discount        Decimal  @default(0)
  total           Decimal  @default(0)
  amountPaid      Decimal  @default(0)
  amountDue       Decimal  @default(0)
  
  // Currency
  currency        String   @default("USD")
  exchangeRate    Decimal  @default(1)
  
  notes           String?
  terms           String?  // Payment terms text
  
  // Relations - can be linked to customer OR supplier
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  
  supplierId      String?
  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  
  // Link to source order
  salesOrderId    String?
  purchaseOrderId String?
  
  createdById     String?
  createdBy       User?    @relation(fields: [createdById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  items           InvoiceItem[]
  payments        Payment[]

  @@map("invoices")
}

model InvoiceItem {
  id              String   @id @default(cuid())
  description     String
  quantity        Int
  unitPrice       Decimal
  taxRate         Decimal  @default(0)
  taxAmount       Decimal  @default(0)
  total           Decimal
  
  // Optional product reference
  productId       String?
  product         Product? @relation(fields: [productId], references: [id])
  
  // Relations
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("invoice_items")
}

model Payment {
  id              String   @id @default(cuid())
  paymentNumber   String   @unique // e.g., "PAY-2024-001"
  amount          Decimal
  method          String   @default("BANK_TRANSFER") // "CASH" | "BANK_TRANSFER" | "CREDIT_CARD" | "CHECK" | "OTHER"
  
  paymentDate     DateTime @default(now())
  reference       String?  // Check number, transaction ID, etc.
  notes           String?
  
  // Relations
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  recordedById    String?
  recordedBy      User?    @relation(fields: [recordedById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("payments")
}

// ============================================
// BATCH / LOT / SERIAL TRACKING
// ============================================

model Batch {
  id              String   @id @default(cuid())
  batchNumber     String   // e.g., "LOT-2024-001"
  
  // Dates
  manufactureDate DateTime?
  expiryDate      DateTime?
  receivedDate    DateTime @default(now())
  
  // Quantity tracking
  initialQty      Int
  currentQty      Int
  
  // Source
  supplierId      String?
  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  purchaseOrderId String?
  
  // Quality
  qualityStatus   String   @default("PENDING") // "PENDING" | "APPROVED" | "REJECTED" | "QUARANTINE"
  qualityNotes    String?
  
  notes           String?
  
  // Relations
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  locationId      String?
  location        Location? @relation(fields: [locationId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Serial numbers within this batch
  serialNumbers   SerialNumber[]
  batchMovements  BatchMovement[]

  @@unique([productId, batchNumber])
  @@map("batches")
}

model SerialNumber {
  id              String   @id @default(cuid())
  serialNumber    String   @unique
  status          String   @default("IN_STOCK") // "IN_STOCK" | "SOLD" | "RETURNED" | "DEFECTIVE" | "RESERVED"
  
  // Warranty
  warrantyExpiry  DateTime?
  
  notes           String?
  
  // Relations
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  batchId         String?
  batch           Batch?   @relation(fields: [batchId], references: [id])
  
  locationId      String?
  location        Location? @relation(fields: [locationId], references: [id])
  
  // Sales tracking
  soldToCustomerId String?
  soldToCustomer   Customer? @relation(fields: [soldToCustomerId], references: [id])
  salesOrderId     String?
  soldDate         DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("serial_numbers")
}

model BatchMovement {
  id              String   @id @default(cuid())
  type            String   // "IN" | "OUT" | "TRANSFER" | "ADJUSTMENT"
  quantity        Int
  reference       String?
  notes           String?
  
  // Relations
  batchId         String
  batch           Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  
  fromLocationId  String?
  fromLocation    Location? @relation("BatchFromLocation", fields: [fromLocationId], references: [id])
  
  toLocationId    String?
  toLocation      Location? @relation("BatchToLocation", fields: [toLocationId], references: [id])
  
  createdById     String?
  createdBy       User?    @relation(fields: [createdById], references: [id])
  
  createdAt       DateTime @default(now())

  @@map("batch_movements")
}

// ============================================
// CRM - LEADS & OPPORTUNITIES
// ============================================
// LeadStatus: "NEW" | "CONTACTED" | "QUALIFIED" | "UNQUALIFIED" | "CONVERTED"
// LeadSource: "WEBSITE" | "REFERRAL" | "COLD_CALL" | "TRADE_SHOW" | "SOCIAL_MEDIA" | "OTHER"
// OpportunityStage: "PROSPECTING" | "QUALIFICATION" | "PROPOSAL" | "NEGOTIATION" | "CLOSED_WON" | "CLOSED_LOST"

model Lead {
  id              String   @id @default(cuid())
  
  // Contact info
  firstName       String
  lastName        String
  email           String?
  phone           String?
  company         String?
  jobTitle        String?
  
  // Lead details
  status          String   @default("NEW")
  source          String   @default("WEBSITE")
  rating          String?  // "HOT" | "WARM" | "COLD"
  
  // Estimated value
  estimatedValue  Decimal?
  
  notes           String?
  
  // Assignment
  assignedToId    String?
  assignedTo      User?    @relation("LeadAssignment", fields: [assignedToId], references: [id])
  
  // Conversion
  convertedToCustomerId String? @unique
  convertedToCustomer   Customer? @relation("LeadConversion", fields: [convertedToCustomerId], references: [id])
  convertedDate   DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Activities
  activities      Activity[]

  @@map("leads")
}

model Opportunity {
  id              String   @id @default(cuid())
  name            String
  description     String?
  
  // Pipeline
  stage           String   @default("PROSPECTING")
  probability     Int      @default(0) // 0-100%
  
  // Value
  amount          Decimal
  currency        String   @default("USD")
  
  // Dates
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  
  // Relations
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  
  assignedToId    String?
  assignedTo      User?    @relation("OpportunityAssignment", fields: [assignedToId], references: [id])
  
  // If won, link to sales order
  salesOrderId    String?
  
  notes           String?
  lostReason      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Activities
  activities      Activity[]

  @@map("opportunities")
}

model Activity {
  id              String   @id @default(cuid())
  type            String   // "CALL" | "EMAIL" | "MEETING" | "TASK" | "NOTE"
  subject         String
  description     String?
  
  // Scheduling
  dueDate         DateTime?
  completedDate   DateTime?
  isCompleted     Boolean  @default(false)
  
  // Duration for calls/meetings (minutes)
  duration        Int?
  
  // Relations - can be linked to Lead, Opportunity, or Customer
  leadId          String?
  lead            Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  opportunityId   String?
  opportunity     Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  assignedToId    String?
  assignedTo      User?    @relation("ActivityAssignment", fields: [assignedToId], references: [id])
  
  createdById     String?
  createdBy       User?    @relation("ActivityCreator", fields: [createdById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("activities")
}

// ============================================
// AUTHENTICATION (NextAuth.js)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

