generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============================================
// TYPE CONSTANTS (SQLite doesn't support enums)
// ============================================
// LocationType: "ZONE" | "RACK" | "SHELF" | "BIN"
// MovementType: "IN" | "OUT" | "TRANSFER"
// OrderStatus: "DRAFT" | "PENDING" | "CONFIRMED" | "SHIPPED" | "DELIVERED" | "CANCELLED"
// POStatus: "DRAFT" | "SENT" | "CONFIRMED" | "PARTIAL" | "RECEIVED" | "CANCELLED"

// ============================================
// CORE MODELS
// ============================================

model Product {
  id          String   @id @default(cuid())
  name        String
  sku         String   @unique
  category    String
  
  // The Basics
  currentStock Int      @default(0)
  price        Decimal
  cost         Decimal // Cost to acquire
  
  // The "Balance" Fields
  reorderPoint Int      @default(10) // Safety Stock / Min Level
  maxStock     Int      @default(100) // Liquidity Cap / Max Level
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  stockItems       StockItem[]
  stockMovements   StockMovement[]
  purchaseItems    PurchaseOrderItem[]
  salesItems       SalesOrderItem[]
  supplierProducts SupplierProduct[]

  @@map("products")
}

// ============================================
// WAREHOUSE MANAGEMENT
// ============================================

model Warehouse {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique // Short code like "WH-001"
  address     String?
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  locations   Location[]

  @@map("warehouses")
}

model Location {
  id          String       @id @default(cuid())
  name        String       // e.g., "Zone A", "Rack 1", "Shelf 3", "Bin A1"
  code        String       // e.g., "WH001-A-R1-S3-B1"
  type        String       // "ZONE" | "RACK" | "SHELF" | "BIN"
  capacity    Int?         // Optional max capacity
  
  // Self-referential tree structure
  parentId    String?
  parent      Location?    @relation("LocationTree", fields: [parentId], references: [id])
  children    Location[]   @relation("LocationTree")
  
  // Warehouse relation
  warehouseId String
  warehouse   Warehouse    @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  stockItems          StockItem[]
  outgoingMovements   StockMovement[] @relation("FromLocation")
  incomingMovements   StockMovement[] @relation("ToLocation")

  @@unique([warehouseId, code])
  @@map("locations")
}

// ============================================
// STOCK TRACKING
// ============================================

model StockItem {
  id          String   @id @default(cuid())
  quantity    Int      @default(0)
  
  // Product relation
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Location relation
  locationId  String
  location    Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Composite unique: one stock record per product per location
  @@unique([productId, locationId])
  @@map("stock_items")
}

model StockMovement {
  id          String       @id @default(cuid())
  type        String       // "IN" | "OUT" | "TRANSFER"
  quantity    Int
  reference   String?      // PO number, SO number, transfer ref, etc.
  notes       String?
  
  // Product relation
  productId   String
  product     Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // For IN movements: toLocation only
  // For OUT movements: fromLocation only
  // For TRANSFER: both fromLocation and toLocation
  fromLocationId String?
  fromLocation   Location?  @relation("FromLocation", fields: [fromLocationId], references: [id])
  
  toLocationId   String?
  toLocation     Location?  @relation("ToLocation", fields: [toLocationId], references: [id])
  
  // Audit fields
  createdAt   DateTime     @default(now())
  createdBy   String?      // User ID reference
  user        User?        @relation(fields: [createdBy], references: [id])

  @@map("stock_movements")
}

// ============================================
// USER MANAGEMENT
// ============================================
// UserRole: "ADMIN" | "MANAGER" | "OPERATOR" | "VIEWER"

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  avatar      String?  // URL to avatar image
  role        String   @default("OPERATOR") // "ADMIN" | "MANAGER" | "OPERATOR" | "VIEWER"
  isActive    Boolean  @default(true)
  
  // Preferences (stored as JSON string for SQLite)
  preferences String?  // JSON: { theme, notifications, language, timezone }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime?

  // Relations
  stockMovements  StockMovement[]
  purchaseOrders  PurchaseOrder[]
  salesOrders     SalesOrder[]

  @@map("users")
}

// ============================================
// SUPPLIER MANAGEMENT
// ============================================

model Supplier {
  id           String   @id @default(cuid())
  name         String
  code         String   @unique // e.g., "SUP-001"
  email        String?
  phone        String?
  address      String?
  contactName  String?
  website      String?
  notes        String?
  isActive     Boolean  @default(true)
  
  // Payment terms
  paymentTerms String?  // e.g., "Net 30", "Net 60"
  leadTimeDays Int?     // Average lead time in days
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  products       SupplierProduct[]
  purchaseOrders PurchaseOrder[]

  @@map("suppliers")
}

model SupplierProduct {
  id            String   @id @default(cuid())
  supplierSku   String?  // Supplier's SKU for this product
  unitCost      Decimal  // Cost from this supplier
  minOrderQty   Int      @default(1)
  leadTimeDays  Int?     // Lead time for this specific product
  isPreferred   Boolean  @default(false) // Preferred supplier for this product
  
  // Relations
  supplierId    String
  supplier      Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([supplierId, productId])
  @@map("supplier_products")
}

// ============================================
// PURCHASE ORDERS
// ============================================
// POStatus: "DRAFT" | "SENT" | "CONFIRMED" | "PARTIAL" | "RECEIVED" | "CANCELLED"

model PurchaseOrder {
  id              String   @id @default(cuid())
  orderNumber     String   @unique // e.g., "PO-2024-001"
  status          String   @default("DRAFT")
  
  // Dates
  orderDate       DateTime @default(now())
  expectedDate    DateTime? // Expected delivery date
  receivedDate    DateTime? // Actual received date
  
  // Financial
  subtotal        Decimal  @default(0)
  tax             Decimal  @default(0)
  shipping        Decimal  @default(0)
  total           Decimal  @default(0)
  
  notes           String?
  
  // Relations
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  
  createdById     String?
  createdBy       User?    @relation(fields: [createdById], references: [id])
  
  // Delivery location
  warehouseId     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Line items
  items           PurchaseOrderItem[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String   @id @default(cuid())
  quantity        Int
  unitCost        Decimal
  receivedQty     Int      @default(0) // Quantity actually received
  
  // Relations
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("purchase_order_items")
}

// ============================================
// CUSTOMERS & SALES ORDERS
// ============================================

model Customer {
  id           String   @id @default(cuid())
  name         String
  code         String   @unique // e.g., "CUST-001"
  email        String?
  phone        String?
  address      String?
  contactName  String?
  company      String?
  notes        String?
  isActive     Boolean  @default(true)
  
  // Credit terms
  creditLimit  Decimal? 
  paymentTerms String?  // e.g., "Net 30"
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  salesOrders  SalesOrder[]

  @@map("customers")
}

// OrderStatus: "DRAFT" | "PENDING" | "CONFIRMED" | "SHIPPED" | "DELIVERED" | "CANCELLED"

model SalesOrder {
  id              String   @id @default(cuid())
  orderNumber     String   @unique // e.g., "SO-2024-001"
  status          String   @default("DRAFT")
  
  // Dates
  orderDate       DateTime @default(now())
  shippedDate     DateTime?
  deliveredDate   DateTime?
  
  // Financial
  subtotal        Decimal  @default(0)
  tax             Decimal  @default(0)
  shipping        Decimal  @default(0)
  discount        Decimal  @default(0)
  total           Decimal  @default(0)
  
  // Shipping info
  shippingAddress String?
  trackingNumber  String?
  
  notes           String?
  
  // Relations
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  
  createdById     String?
  createdBy       User?    @relation(fields: [createdById], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Line items
  items           SalesOrderItem[]

  @@map("sales_orders")
}

model SalesOrderItem {
  id              String   @id @default(cuid())
  quantity        Int
  unitPrice       Decimal
  shippedQty      Int      @default(0) // Quantity actually shipped
  
  // Relations
  salesOrderId    String
  salesOrder      SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("sales_order_items")
}

